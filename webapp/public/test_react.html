<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test React Station Selection Logic</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .debug { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Testing Station Selection Logic</h1>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function TestApp() {
            const [stops, setStops] = useState({});
            const [trips, setTrips] = useState({});
            const [tripStops, setTripStops] = useState({});
            const [selectedStations, setSelectedStations] = useState([]);
            const [filteredTrips, setFilteredTrips] = useState([]);
            const [loading, setLoading] = useState(true);
            const [logs, setLogs] = useState([]);

            const addLog = (msg) => {
                setLogs(prev => [...prev, `${new Date().toISOString().substr(11,12)}: ${msg}`]);
                console.log(msg);
            };

            // Load data
            useEffect(() => {
                const loadData = async () => {
                    try {
                        addLog('Loading data...');
                        const [stopsRes, tripsRes, tripStopsRes] = await Promise.all([
                            fetch('/data/stops.json'),
                            fetch('/data/trips.json'),
                            fetch('/data/trip_stop.json')
                        ]);

                        const [stopsData, tripsData, tripStopsData] = await Promise.all([
                            stopsRes.json(),
                            tripsRes.json(),
                            tripStopsRes.json()
                        ]);

                        addLog(`Loaded: ${Object.keys(stopsData).length} stops, ${Object.keys(tripsData).length} trips, ${Object.keys(tripStopsData).length} trip_stops`);

                        setStops(stopsData);
                        setTrips(tripsData);
                        setTripStops(tripStopsData);
                        setLoading(false);
                    } catch (err) {
                        addLog(`ERROR: ${err.message}`);
                        setLoading(false);
                    }
                };

                loadData();
            }, []);

            // Filter trips based on selected stations (EXACT COPY FROM App.jsx)
            useEffect(() => {
                addLog(`Filtering triggered. Selected stations: ${selectedStations.length}, Trips: ${Object.keys(trips).length}, TripStops: ${Object.keys(tripStops).length}`);

                if (selectedStations.length === 0) {
                    setFilteredTrips([]);
                    return;
                }

                const selectedStationIds = new Set(selectedStations.map(s => s.stop_id));
                addLog(`Selected station IDs: ${Array.from(selectedStationIds).join(', ')}`);
                
                const matchingTrips = [];

                Object.values(trips).forEach(trip => {
                    const tripId = trip.trip_id;
                    const stopsForTrip = Object.values(tripStops).filter(
                        ts => ts.trip_id === tripId
                    );
                    const hasMatchingStation = stopsForTrip.some(
                        ts => selectedStationIds.has(ts.stop_id)
                    );

                    if (hasMatchingStation) {
                        matchingTrips.push({
                            trip,
                            stops: stopsForTrip.sort((a, b) => a.stop_sequence - b.stop_sequence)
                        });
                    }
                });

                addLog(`Found ${matchingTrips.length} matching trips`);
                setFilteredTrips(matchingTrips);
            }, [selectedStations, trips, tripStops]);

            const selectArad = () => {
                addLog('User clicked "Select Arad"');
                const aradStation = stops['Arad'];
                if (aradStation) {
                    addLog(`Found Arad station: ${JSON.stringify(aradStation).substr(0, 100)}...`);
                    setSelectedStations([aradStation]);
                } else {
                    addLog('ERROR: Arad station not found!');
                }
            };

            if (loading) {
                return <div>Loading...</div>;
            }

            return (
                <div>
                    <div className="debug">
                        <h3>Data Status</h3>
                        <p>Stops: {Object.keys(stops).length}</p>
                        <p>Trips: {Object.keys(trips).length}</p>
                        <p>Trip Stops: {Object.keys(tripStops).length}</p>
                        <p>Selected Stations: {selectedStations.length}</p>
                        <p className={filteredTrips.length > 0 ? 'success' : 'error'}>
                            Filtered Trips: {filteredTrips.length}
                        </p>
                    </div>

                    <button onClick={selectArad}>Select Arad Station</button>

                    {filteredTrips.length > 0 && (
                        <div className="debug">
                            <h3>Filtered Trips</h3>
                            {filteredTrips.slice(0, 5).map(({ trip }) => (
                                <div key={trip.trip_id}>
                                    {trip.trip_short_name}: {trip.trip_origin} â†’ {trip.trip_headsign}
                                </div>
                            ))}
                        </div>
                    )}

                    <div className="debug">
                        <h3>Debug Log</h3>
                        {logs.map((log, i) => (
                            <div key={i}>{log}</div>
                        ))}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<TestApp />, document.getElementById('root'));
    </script>
</body>
</html>
